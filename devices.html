<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<title>‌فرم ثبت اطلاعات ‌دیوایس‌</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazir-font@v30.1.0/dist/font-face.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/css/persian-datepicker.min.css"/>
<script src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/persian-date/dist/persian-date.js"></script>
<script src="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/js/persian-datepicker.min.js"></script>
<style>
/* … تمام استایل‌ها همانند نسخه قبل … */
</style>
</head>
<body>
<div class="container">
<h2>فرم ثبت اطلاعات دیوایس‌های معیوب</h2>

<form id="deviceForm">
<div class="compact-barcode-display">
  بارکد فعلی: <span id="barcodeDisplay">---</span>
</div>
<input type="hidden" id="barcodeId" name="barcodeId">

<!-- کارت‌ها و فیلدها همانند نسخه قبل … -->

<div class="button-group">
  <button type="submit" id="saveBtn"><i class="fa-solid fa-floppy-disk"></i> ثبت/ویرایش</button>
  <button type="button" id="deleteBtn"><i class="fa-solid fa-trash-can"></i> حذف</button>
</div>
</form>

<div class="message-container" id="messageContainer">
    <div class="message-box success" id="successMsg"></div>
    <div class="message-box error" id="errorMsg"></div>
</div>

<div class="search-container">
<input type="text" id="searchCode" placeholder="جستجو بر اساس کد دیوایس">
<button type="button" id="searchBtn"><i class="fa-solid fa-magnifying-glass"></i> جستجو</button>
</div>
</div>

<script>
const scriptURL = "https://script.google.com/macros/s/AKfycbxNSYF4aK2DM2FJXqSCaBOH-XmblwXA2U8Wm8yv5H0ZKzE_FM6cqXLQTYgKqH2TSiwS/exec";
const urlParams = new URLSearchParams(window.location.search);
const barcodeId = urlParams.get("barcodeId");
document.getElementById("barcodeId").value = barcodeId || "";
document.getElementById("barcodeDisplay").textContent = barcodeId || "---";

$(document).ready(function() {
  $("#issueDate").persianDatepicker({
    format: "YYYY/MM/DD",
    autoClose: true,
    initialValue: false,
    calendar: { persian: { locale: "fa" } }
  });
});

function showMessage(type, message) {
    const messageContainer = document.getElementById("messageContainer");
    const successMsg = document.getElementById("successMsg");
    const errorMsg = document.getElementById("errorMsg");
    if (!successMsg || !errorMsg || !messageContainer) return;
    const targetMsg = (type === "success") ? successMsg : errorMsg;
    const otherMsg = (type === "success") ? errorMsg : successMsg;
    targetMsg.textContent = message;
    messageContainer.classList.add("visible");
    targetMsg.style.display = 'block';
    otherMsg.style.display = 'none';
    setTimeout(() => {
        messageContainer.classList.remove("visible");
    }, 4000);
}

function fillForm(data){
  if(!data) return;
  if (Object.keys(data).length > 0) {
    for(const key in data){
      const el = document.querySelector("[name='"+key+"']");
      if(el){
          if(el.type === "radio" || el.type === "checkbox"){
             el.checked = (el.value === data[key]);
          } else {
             el.value = data[key]||"";
          }
      }
    }
    document.getElementById("barcodeDisplay").textContent = data.barcodeId || "---";
    // پیام موفقیت جستجو فقط یکبار نمایش داده می‌شود
    // حذف پیام اضافی در سایر فراخوانی‌ها
}

if(barcodeId){
  fetch(`${scriptURL}?action=get&barcodeId=${encodeURIComponent(barcodeId)}`)
    .then(res=>res.json())
    .then(data=>{ 
        if(Object.keys(data).length > 0){
            fillForm(data); 
            showMessage("success", "✅ دیوایس با این بارکد پیدا شد");
        } else {
            showMessage("error", "❌ دیوایس با این بارکد پیدا نشد");
        }
    })
    .catch(err=>{
      console.error("خطا در دریافت اطلاعات", err);
      showMessage("error", "❌ خطا در دریافت اطلاعات");
    });
}

document.getElementById("deviceForm").addEventListener("submit", e=>{
  e.preventDefault();
  const formData = new FormData(e.target);
  showLoading('saveBtn', 'fa-solid fa-floppy-disk');
  fetch(scriptURL,{method:"POST",body:formData})
    .then(res=>res.text())
    .then(resp=>{
        if(resp.startsWith("Error")){
            showMessage("error", "❌ " + resp.replace("Error: ",""));
        } else {
            showMessage("success", "✅ اطلاعات دیوایس ثبت شد");
        }
    })
    .catch(err=>{ showMessage("error", "❌ خطا در پردازش اطلاعات"); })
    .finally(() => { hideLoading('saveBtn'); });
});

document.getElementById("deleteBtn").addEventListener("click", ()=>{
  if(!barcodeId) return;
  if(!confirm("آیا مطمئن هستید؟")) return;
  showLoading('deleteBtn', 'fa-solid fa-trash-can');
  fetch(`${scriptURL}?action=delete&barcodeId=${encodeURIComponent(barcodeId)}`)
    .then(res=>res.text())
    .then(resp=>{
        if(resp.startsWith("Error")){
            showMessage("error", "❌ " + resp.replace("Error: ",""));
        } else {
            document.getElementById("deviceForm").reset();
            document.getElementById("barcodeDisplay").textContent = "---";
            showMessage("success", "✅ اطلاعات دیوایس حذف شد");
        }
    })
    .catch(err=>{
      showMessage("error", "❌ خطا در حذف اطلاعات دیوایس");
    })
    .finally(() => { hideLoading('deleteBtn'); });
});

document.getElementById("searchBtn").addEventListener("click", ()=>{
  const code = document.getElementById("searchCode").value.trim();
  if(!code) return showMessage("error", "❌ کد دیوایس وارد شود");
  showLoading('searchBtn', 'fa-solid fa-magnifying-glass');
  fetch(`${scriptURL}?action=getByCode&deviceCode=${encodeURIComponent(code)}`)
    .then(res=>res.json())
    .then(data=>{
      if(Object.keys(data).length > 0){
        fillForm(data);
        document.getElementById("barcodeId").value = data.barcodeId||"";
        showMessage("success", "✅ دیوایس با این کد پیدا شد");
      }else{
        showMessage("error", "❌ برای کد وارد شده دیوایسی پیدا نشد");
      }
    }).catch(err=>{
      console.error(err);
      showMessage("error", "❌ خطا در جستجو");
    }).finally(() => { hideLoading('searchBtn'); });
});
</script>
</body>
</html>
