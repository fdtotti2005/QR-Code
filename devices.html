<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<title>‌فرم ثبت اطلاعات ‌دیوایس‌</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazir-font@v30.1.0/dist/font-face.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/css/persian-datepicker.min.css"/>
<script src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/persian-date/dist/persian-date.js"></script>
<script src="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/js/persian-datepicker.min.js"></script>
<style>
/* استایل ها همانند قبل */
</style>
</head>
<body>
<div class="container">
    <!-- فرم و دکمه ها همانند قبل -->
</div>

<script>
const scriptURL = "https://script.google.com/macros/s/AKfycbxGwiJeyjFwVHRKr-_SvQM_3GInWAyC1EpU_yIMQTuJt9-NHIL_kKK1sGU2ytJYHzzWXQ/exec";
const urlParams = new URLSearchParams(window.location.search);
const barcodeId = urlParams.get("barcodeId");
document.getElementById("barcodeId").value = barcodeId || "";
document.getElementById("barcodeDisplay").textContent = barcodeId || "---";

// تاریخ شمسی
$(document).ready(function() {
    $("#issueDate").persianDatepicker({
        format: "YYYY/MM/DD",
        autoClose: true,
        initialValue: false,
        calendar: { persian: { locale: "fa" } }
    });
});

function showMessage(type, message) {
    const messageContainer = document.getElementById("messageContainer");
    const successMsg = document.getElementById("successMsg");
    const errorMsg = document.getElementById("errorMsg");
    if (!successMsg || !errorMsg || !messageContainer) return;
    const targetMsg = (type === "success") ? successMsg : errorMsg;
    const otherMsg = (type === "success") ? errorMsg : successMsg;
    targetMsg.textContent = message;
    messageContainer.classList.add("visible");
    targetMsg.style.display = 'block';
    otherMsg.style.display = 'none';
    setTimeout(() => { messageContainer.classList.remove("visible"); }, 4000);
}

function fillForm(data) {
    if (!data) return;
    for (const key in data) {
        const el = document.querySelector(`[name='${key}']`);
        if (el) {
            if (el.type === "radio" || el.type === "checkbox") el.checked = (el.value === data[key]);
            else el.value = data[key] || "";
        }
    }
    document.getElementById("barcodeDisplay").textContent = data.barcodeId || "---";
}

function showLoading(buttonId, originalIconClass) {
    const button = document.getElementById(buttonId);
    button.dataset.originalIcon = originalIconClass;
    button.dataset.originalText = button.innerText.replace(/\s*$/, '');
    button.classList.add('loading');
    button.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
}

function hideLoading(buttonId) {
    const button = document.getElementById(buttonId);
    button.classList.remove('loading');
    const originalIconClass = button.dataset.originalIcon;
    const originalText = button.dataset.originalText;
    if (originalIconClass && originalText !== undefined) {
        button.innerHTML = `<i class="${originalIconClass}"></i> ${originalText}`;
    }
}

// اصلاح شده: fetchAndHandleData
function fetchAndHandleData(url, successMessage, notFoundMessage) {
    return fetch(url)
        .then(res => res.text())
        .then(text => {
            let data = {};
            try { data = JSON.parse(text); } catch(err) { data = {}; }
            if (Object.keys(data).length > 0) {
                fillForm(data);
                showMessage("success", successMessage);
            } else {
                showMessage("error", notFoundMessage);
            }
        })
        .catch(err => {
            console.error("Fetch Error:", err);
            showMessage("error", "❌ خطای شبکه یا خطای نامشخص");
        });
}

// بررسی اولیه
if (barcodeId) {
    fetchAndHandleData(`${scriptURL}?action=get&barcodeId=${encodeURIComponent(barcodeId)}`, 
                       "✅ دیوایس با این بارکد پیدا شد", 
                       "❌ دیوایس با این بارکد پیدا نشد");
}

// رویداد ارسال فرم
document.getElementById("deviceForm").addEventListener("submit", e => {
    e.preventDefault();
    const formData = new FormData(e.target);
    showLoading('saveBtn', 'fa-solid fa-floppy-disk');
    fetch(scriptURL, { method: "POST", body: formData })
        .then(res => res.text())
        .then(text => {
            if (text.trim() === "OK") showMessage("success", "✅ اطلاعات دیوایس ثبت شد");
            else showMessage("error", "❌ خطا در ثبت اطلاعات دیوایس");
        })
        .catch(err => {
            console.error("Fetch Error:", err);
            showMessage("error", "❌ خطای شبکه یا خطای نامشخص در ثبت اطلاعات");
        })
        .finally(() => { hideLoading('saveBtn'); });
});

// دکمه حذف
document.getElementById("deleteBtn").addEventListener("click", () => {
    const currentBarcodeId = document.getElementById("barcodeId").value;
    if (!currentBarcodeId) return showMessage("error", "❌ بارکدی برای حذف انتخاب نشده است");
    if (!confirm("آیا مطمئن هستید؟")) return;
    showLoading('deleteBtn', 'fa-solid fa-trash-can');
    fetch(`${scriptURL}?action=delete&barcodeId=${encodeURIComponent(currentBarcodeId)}`)
        .then(res => res.text())
        .then(text => {
            if (text.trim() === "Deleted") {
                document.getElementById("deviceForm").reset();
                document.getElementById("barcodeDisplay").textContent = "---";
                document.getElementById("barcodeId").value = "";
                showMessage("success", "✅ اطلاعات دیوایس حذف شد");
            } else showMessage("error", "❌ خطا در حذف اطلاعات دیوایس");
        })
        .catch(err => {
            console.error("Fetch Error:", err);
            showMessage("error", "❌ خطای شبکه یا خطای نامشخص در حذف اطلاعات");
        })
        .finally(() => { hideLoading('deleteBtn'); });
});

// دکمه جستجو
document.getElementById("searchBtn").addEventListener("click", () => {
    const code = document.getElementById("searchCode").value.trim();
    if (!code) return showMessage("error", "❌ کد دیوایس را وارد کنید");
    showLoading('searchBtn', 'fa-solid fa-magnifying-glass');
    fetchAndHandleData(`${scriptURL}?action=getByCode&deviceCode=${encodeURIComponent(code)}`, 
                       "✅ دیوایس با این کد پیدا شد", 
                       "❌ برای کد وارد شده دیوایسی پیدا نشد")
        .finally(() => { hideLoading('searchBtn'); });
});
</script>
</body>
</html>
