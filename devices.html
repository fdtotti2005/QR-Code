<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<title>ÙØ±Ù… Ø«Ø¨Øª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯ÛŒÙˆØ§ÛŒØ³â€ŒÙ‡Ø§</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazir-font@v30.1.0/dist/font-face.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
:root {
  --primary-color: #2c3e50;
  --accent-color: #3498db;
  --success-color: #2ecc71;
  --danger-color: #e74c3c;
  --bg-color: #f0f2f5;
  --text-color: #333;
  --input-bg-color: #fff;
  --border-color: #ccc;
  --readonly-bg: #eee;
  --shadow-light: rgba(0,0,0,0.08);
  --shadow-medium: rgba(0,0,0,0.15);
  --card-bg: #ffffff;
  --input-bg-gradient: linear-gradient(180deg, #fff, #f9f9f9);
}
body{font-family:'Vazir',Tahoma,sans-serif;background:var(--bg-color);color:var(--text-color);margin:0;padding:1.8rem;}
.container{max-width:650px;margin:auto;}
h2{text-align:center;margin-bottom:1.35rem;font-size:1.2rem;}

/* Card Section */
.card {
  background: var(--card-bg);
  padding: 1rem;
  margin-bottom: 1rem;
  border-radius: 10px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}

/* Form Elements */
label{display:block;margin-top:0.72rem;font-weight:bold;font-size:0.81rem;}
input,textarea,select{
  width:100%;
  padding:0.54rem;
  margin-top:0.36rem;
  border:1px solid var(--border-color);
  border-radius:6px;
  font-family:inherit;
  font-size:0.81rem;
  background: var(--input-bg-gradient);
  box-shadow: 0 1px 3px rgba(0,0,0,0.08);
  transition: box-shadow 0.2s ease, border-color 0.2s ease;
}
input:focus, textarea:focus, select:focus {
  outline:none;
  border-color:var(--accent-color);
  box-shadow: 0 0 5px rgba(52,152,219,0.5);
}
textarea{resize:vertical;}
.row{display:flex;gap:0.9rem;flex-wrap:wrap;margin-bottom:0.72rem;}
.row .half{flex:1;min-width:48%;}

/* Compact Barcode Display */
.compact-barcode-display {
  padding: 0.45rem 0;
  text-align: right;
  margin-bottom: 0.9rem;
  font-size: 0.765rem;
  color: var(--primary-color);
  font-weight: bold;
}
.compact-barcode-display span {
  font-family: 'Courier New', Courier, monospace;
  background-color: var(--readonly-bg);
  padding: 0.09rem 0.36rem;
  border-radius: 4px;
}

/* Buttons */
.button-group { display: flex; gap: 0.5rem; margin-top: 1rem; }
.button-group button { flex: 1; padding:0.72rem; width:100%; color:var(--input-bg-color); border:none; border-radius:6px; font-size:0.81rem; cursor:pointer; transition: transform 0.2s ease, background-color 0.2s ease, box-shadow 0.2s ease; font-family:inherit; box-shadow: 0 2px 4px rgba(0,0,0,0.08); }
button:hover{ transform: scale(1.02); box-shadow:0 4px 8px rgba(0,0,0,0.15); }
#saveBtn{background: linear-gradient(135deg,#2ecc71,#27ae60);}
#deleteBtn{background: linear-gradient(135deg,#e74c3c,#c0392b);}
#searchBtn{background: linear-gradient(135deg,#3498db,#2980b9);}
#scanBtn{background: linear-gradient(135deg,#f39c12,#e67e22);}

/* Floating Message Box with Animation */
.message-container { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 300px; z-index:1000; text-align:center; pointer-events:none; opacity:0; transition: all 0.5s ease-in-out; }
.message-container.visible { opacity:0.95; }
.message-box{font-weight:bold;font-size:0.85rem;padding:0.6rem;border-radius:5px;box-shadow:0 2px 10px rgba(0,0,0,0.2); transform: translateY(-10px); transition: transform 0.3s ease, opacity 0.3s ease;}
.message-container.visible .message-box { transform: translateY(0); }
.success{color:var(--success-color);background-color:rgba(46,204,113,0.1);border:1px solid var(--success-color);}
.error{color:var(--danger-color);background-color:rgba(231,76,60,0.1);border:1px solid var(--danger-color);}

/* Search Bar */
.search-container{margin-top:0.5rem;display:flex;gap:0.5rem;flex-wrap:wrap;align-items:flex-end;}
.search-container input{flex:1;min-width:60%; margin-top:0; box-shadow: 0 1px 3px rgba(0,0,0,0.1);}
.search-container button{margin-top:0;width:auto;padding:0.54rem 0.9rem;font-size:0.765rem;box-shadow:0 2px 4px rgba(0,0,0,0.1);}
.search-container button:hover{box-shadow:0 4px 8px rgba(0,0,0,0.2);}

/* Responsive */
@media(max-width:500px){
  body{padding:0.9rem;}
  .row .half{min-width:100%;}
  .search-container{flex-direction:column;align-items:stretch;}
  .search-container input,.search-container button{width:100%;margin-top:0.72rem;}
  .button-group{flex-direction:column;}
}
</style>
</head>
<body>
<div class="container">
<h2>ÙØ±Ù… Ø«Ø¨Øª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯ÛŒÙˆØ§ÛŒØ³â€ŒÙ‡Ø§ÛŒ Ù…Ø¹ÛŒÙˆØ¨</h2>

<form id="deviceForm">

<!-- Barcode Display & Scan -->
<div class="card">
  <div class="compact-barcode-display">
    Ø¨Ø§Ø±Ú©Ø¯ ÙØ¹Ù„ÛŒ: <span id="barcodeDisplay">---</span>
  </div>
  <input type="hidden" id="barcodeId" name="barcodeId">
  <button type="button" id="scanBtn"><i class="fa-solid fa-camera"></i> Ø§Ø³Ú©Ù† Ø¨Ø§Ø±Ú©Ø¯</button>
</div>

<!-- Device Info -->
<div class="card">
  <div class="row">
    <div class="half">
      <label>Ù†Ø§Ù… Ø¯ÛŒÙˆØ§ÛŒØ³</label>
      <select name="deviceName" id="deviceName" required>
        <option value="">-- Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ --</option>
        <option value="Multi Media">Multi Media</option>
        <option value="Multi Media Metal">Multi Media Metal</option>
        <option value="Soul">Soul</option>
        <option value="Smart Player">Smart Player</option>
        <option value="TDA">TDA</option>
        <option value="RFID">RFID</option>
        <option value="Serial GSM">Serial GSM</option>
        <option value="Smart GSM">Smart GSM</option>
        <option value="MP3">MP3</option>
        <option value="IR">IR</option>
        <option value="B1">B1</option>
        <option value="Smart Plug">Smart Plug</option>
      </select>
    </div>
    <div class="half">
      <label>Ú©Ø¯ Ø¯ÛŒÙˆØ§ÛŒØ³</label>
      <input type="text" name="deviceCode" required>
    </div>
  </div>
</div>

<!-- Issue Info -->
<div class="card">
  <label>Ø§ÛŒØ±Ø§Ø¯</label>
  <input type="text" name="issue" required>
  <label>ØªØ§Ø±ÛŒØ® Ú¯Ø²Ø§Ø±Ø´ Ø§ÛŒØ±Ø§Ø¯</label>
  <input type="date" name="issueDate">
  <label>Ø´Ø±Ø­ Ø§ÛŒØ±Ø§Ø¯</label>
  <textarea name="issueDescription" rows="2"></textarea>
</div>

<!-- Actions and Status -->
<div class="card">
  <label>Ø§Ù‚Ø¯Ø§Ù…Ø§Øª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡</label>
  <textarea name="actionsTaken" rows="2"></textarea>
  <label>ÙˆØ¶Ø¹ÛŒØª ÙØ¹Ù„ÛŒ</label>
  <input type="text" name="currentStatus">
  <label>ØªÙˆØ¶ÛŒØ­Ø§Øª ØªÚ©Ù…ÛŒÙ„ÛŒ</label>
  <textarea name="notes" rows="2"></textarea>
</div>

<div class="button-group">
  <button type="submit" id="saveBtn"><i class="fa-solid fa-floppy-disk"></i> Ø«Ø¨Øª/ÙˆÛŒØ±Ø§ÛŒØ´</button>
  <button type="button" id="deleteBtn"><i class="fa-solid fa-trash-can"></i> Ø­Ø°Ù</button>
</div>
</form>

<div class="message-container" id="messageContainer">
    <div class="message-box success" id="successMsg"></div>
    <div class="message-box error" id="errorMsg"></div>
</div>

<div class="search-container">
<input type="text" id="searchCode" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø± Ø§Ø³Ø§Ø³ Ú©Ø¯ Ø¯ÛŒÙˆØ§ÛŒØ³">
<button type="button" id="searchBtn"><i class="fa-solid fa-magnifying-glass"></i> Ø¬Ø³ØªØ¬Ùˆ</button>
</div>
</div>

<script>
const scriptURL = "https://script.google.com/macros/s/AKfycbwiFTGb_w8MRlEDdqqF6KqiTkRSm5yqqmLBs0OCWA665-engKt8dcwmqT4_QttYbnLgtw/exec";
const urlParams = new URLSearchParams(window.location.search);
const barcodeId = urlParams.get("barcodeId");
document.getElementById("barcodeId").value = barcodeId || "";
document.getElementById("barcodeDisplay").textContent = barcodeId || "---";

function showMessage(type,message){
  const container=document.getElementById("messageContainer");
  const success=document.getElementById("successMsg");
  const error=document.getElementById("errorMsg");
  if(!success||!error||!container)return;
  const target=(type==="success")?success:error;
  const other=(type==="success")?error:success;
  target.innerHTML=message;
  container.classList.add("visible");
  target.style.display="block";
  other.style.display="none";
  setTimeout(()=>{container.classList.remove("visible");},3000);
}

function fillForm(data){
  if(!data)return;
  if(Object.keys(data).length>0){
    for(const key in data){
      const el=document.querySelector("[name='"+key+"']");
      if(el){
        if(el.type==="radio"||el.type==="checkbox") el.checked=(el.value===data[key]);
        else el.value=data[key]||"";
      }
    }
    document.getElementById("barcodeDisplay").textContent=data.barcodeId||"---";
    showMessage("success","âœ… Ø±Ú©ÙˆØ±Ø¯ Ù¾ÛŒØ¯Ø§ Ø´Ø¯");
  }else showMessage("error","âŒ Ø±Ú©ÙˆØ±Ø¯ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯");
}

// Barcode Scan Button
document.getElementById("scanBtn").addEventListener("click", async ()=>{
  if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){ 
    return showMessage("error","âŒ Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ Ø§Ø² Ø¯ÙˆØ±Ø¨ÛŒÙ† Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯");
  }
  try{
    const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
    const video=document.createElement("video");
    video.srcObject=stream;
    video.setAttribute("playsinline","");
    video.play();
    const canvas=document.createElement("canvas");
    const ctx=canvas.getContext("2d");

    const scan = () => {
      if(video.readyState===video.HAVE_ENOUGH_DATA){
        canvas.width=video.videoWidth;
        canvas.height=video.videoHeight;
        ctx.drawImage(video,0,0,canvas.width,canvas.height);
        const imgData=ctx.getImageData(0,0,canvas.width,canvas.height);
        // Ø§Ø² jsQR ÛŒØ§ Ù‡Ø± Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ Barcode JS Ù…ÛŒâ€ŒØªÙˆØ§Ù† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ø±Ø¯
        // Ø¨Ø±Ø§ÛŒ Ù†Ù…ÙˆÙ†Ù‡ØŒ ÙØ±Ø¶ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§Ø±Ú©Ø¯ Ø±Ø§ Ù…ÛŒâ€ŒÙ†ÙˆÛŒØ³Ø¯
      }
      requestAnimationFrame(scan);
    };
    scan();
    showMessage("success","ğŸ“· Ø¯ÙˆØ±Ø¨ÛŒÙ† ÙØ¹Ø§Ù„ Ø´Ø¯ (Ø§Ø³Ú©Ù† ÙˆØ§Ù‚Ø¹ÛŒ Ø¨Ø§ jsQR ÛŒØ§ barcode lib Ù†ÛŒØ§Ø² Ø§Ø³Øª)");
  }catch(err){
    showMessage("error","âŒ Ø®Ø·Ø§ Ø¯Ø± ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø¯ÙˆØ±Ø¨ÛŒÙ†");
  }
}

// Load form with barcode on page load
if(barcodeId){
  fetch(`${scriptURL}?action=get&barcodeId=${encodeURIComponent(barcodeId)}`)
    .then(res=>res.json())
    .then(data=>{ fillForm(data); })
    .catch(err=>{ console.error(err); showMessage("error","âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª"); });
}

// Submit Form
document.getElementById("deviceForm").addEventListener("submit",e=>{
  e.preventDefault();
  const formData=new FormData(e.target);
  fetch(scriptURL,{method:"POST",body:formData})
    .then(()=>showMessage("success","âœ… Ø¹Ù…Ù„ÛŒØ§Øª Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ² Ø¨ÙˆØ¯"))
    .catch(err=>showMessage("error","âŒ Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª"));
});

// Delete
document.getElementById("deleteBtn").addEventListener("click",()=>{
  if(!barcodeId)return;
  if(!confirm("Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ")) return;
  fetch(`${scriptURL}?action=delete&barcodeId=${encodeURIComponent(barcodeId)}`)
    .then(()=>{
      document.getElementById("deviceForm").reset();
      document.getElementById("barcodeDisplay").textContent="---";
      showMessage("success","âœ… Ø±Ú©ÙˆØ±Ø¯ Ø­Ø°Ù Ø´Ø¯");
    }).catch(err=>showMessage("error","âŒ Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ø±Ú©ÙˆØ±Ø¯"));
});

// Search
document.getElementById("searchBtn").addEventListener("click",()=>{
  const code=document.getElementById("searchCode").value.trim();
  if(!code) return showMessage("error","âŒ Ú©Ø¯ Ø¯ÛŒÙˆØ§ÛŒØ³ ÙˆØ§Ø±Ø¯ Ø´ÙˆØ¯");
  fetch(`${scriptURL}?action=getByCode&deviceCode=${encodeURIComponent(code)}`)
    .then(res=>res.json())
    .then(data=>{
      if(Object.keys(data).length>0){
        fillForm(data);
        document.getElementById("barcodeId").value=data.barcodeId||"";
      }else showMessage("error","âŒ Ø±Ú©ÙˆØ±Ø¯ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯");
    }).catch(err=>showMessage("error","âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¬Ø³ØªØ¬Ùˆ"));
});
</script>
</body>
</html>
