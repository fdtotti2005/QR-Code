<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<title>â€ŒÙØ±Ù… Ø«Ø¨Øª Ø§Ø·Ù„Ø§Ø¹Ø§Øª â€ŒØ¯ÛŒÙˆØ§ÛŒØ³â€Œ</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazir-font@v30.1.0/dist/font-face.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/css/persian-datepicker.min.css"/>
<script src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/persian-date/dist/persian-date.js"></script>
<script src="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/js/persian-datepicker.min.js"></script>
<style>
/* Base Colors & Typography */
:root {
  --primary-color: #2c3e50;
  --accent-color: #3498db;
  --success-color: #2ecc71;
  --danger-color: #e74c3c;
  --bg-color: #f0f2f5;
  --text-color: #333;
  --input-bg-color: #fff;
  --border-color: #ccc;
  --readonly-bg: #eee;
  --shadow-light: rgba(0, 0, 0, 0.08);
  --shadow-medium: rgba(0, 0, 0, 0.15);
}

/* ğŸŒ™ Ø¯Ø§Ø±Ú©â€ŒÙ…Ø¯ */
.dark-mode {
  --primary-color: #ecf0f1;
  --accent-color: #3498db;
  --success-color: #2ecc71;
  --danger-color: #e74c3c;
  --bg-color: #1e1e1e;
  --text-color: #e0e0e0;
  --input-bg-color: #2b2b2b;
  --border-color: #555;
  --readonly-bg: #3a3a3a;
  --shadow-light: rgba(255, 255, 255, 0.05);
  --shadow-medium: rgba(255, 255, 255, 0.1);
}

body{font-family:'Vazir',Tahoma,sans-serif;background:var(--bg-color);color:var(--text-color);margin:0;padding:1.8rem;}
.container{max-width:650px;margin:auto;background:var(--input-bg-color);padding:1.8rem;border-radius:10px;box-shadow:0 0 0.5rem rgba(0,0,0,0.1);}
h2{text-align:center;margin-bottom:1.35rem;font-size:1.2rem;}

/* Ø¯Ú©Ù…Ù‡ Ø¯Ø§Ø±Ú©â€ŒÙ…Ø¯ */
.toggle-dark {
  position: fixed;
  top: 15px;
  left: 15px;
  z-index: 1100;
  background: var(--accent-color);
  color: #fff;
  border: none;
  border-radius: 50%;
  width: 42px;
  height: 42px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  box-shadow: 0 2px 6px var(--shadow-medium);
}
.toggle-dark:hover {
  transform: scale(1.1);
  transition: 0.2s;
}

/* Form Elements */
label{display:block;margin-top:0.72rem;font-weight:bold;font-size:0.81rem;}
input,textarea,select{
  width:100%;
  padding:0.54rem;
  margin-top:0.36rem;
  border:1px solid var(--border-color);
  border-radius:6px;
  font-family:inherit;
  font-size:0.81rem;
  box-shadow: 0 1px 3px var(--shadow-light);
  transition: box-shadow 0.2s ease, border-color 0.2s ease;
  background: var(--input-bg-color);
  color: var(--text-color);
}
input:focus, textarea:focus, select:focus {
  outline:none;
  border-color:var(--accent-color);
  box-shadow: 0 0 5px rgba(52, 152, 219, 0.5);
}
textarea{resize:vertical;}
.row{display:flex;gap:0.9rem;flex-wrap:wrap;margin-bottom:0.72rem;}
.row .half{flex:1;min-width:48%;}

/* Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ */
.card {
  background: var(--input-bg-color);
  border-radius: 10px;
  padding: 1rem;
  margin-bottom: 1rem;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  border: 1px solid var(--border-color);
}

/* Compact Barcode Display */
.compact-barcode-display {
  padding: 0.45rem 0;
  text-align: right;
  margin-bottom: 0.9rem;
  font-size: 0.765rem;
  color: var(--primary-color);
  font-weight: bold;
}
.compact-barcode-display span {
  font-family: 'Courier New', Courier, monospace;
  background-color: var(--readonly-bg);
  padding: 0.09rem 0.36rem;
  border-radius: 4px;
}

/* Buttons */
.button-group {
    display: flex;
    gap: 0.5rem;
    margin-top: 1.35rem;
}
.button-group button {
    flex: 1;
}
button{
  padding:0.72rem;
  width:100%;
  color:var(--input-bg-color);
  border:none;
  border-radius:6px;
  font-size:0.81rem;
  cursor:pointer;
  transition: transform 0.2s ease, background-color 0.2s ease, box-shadow 0.2s ease;
  font-family:inherit;
  box-shadow: 0 2px 4px var(--shadow-light);
}
button:hover{
  transform: scale(1.02);
  box-shadow: 0 4px 8px var(--shadow-medium);
}
#saveBtn{
    background: linear-gradient(135deg, #2ecc71, #27ae60);
}
#deleteBtn{
    background: linear-gradient(135deg, #e74c3c, #c0392b);
}
#searchBtn{
    background: linear-gradient(135deg, #3498db, #2980b9);
}
.loading {pointer-events:none;opacity:0.7;cursor:wait;}
.loading i.fa-spin {animation: spin 1s linear infinite;}
@keyframes spin {0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}

/* Floating Message Box */
.message-container {position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:300px;z-index:1000;text-align:center;pointer-events:none;opacity:0;transition:opacity 0.5s;}
.message-container.visible {opacity:1;}
.message-box{font-weight:bold;font-size:0.85rem;padding:0.6rem;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,0.3);}
.success{color:var(--success-color);background-color:rgba(46,204,113,0.2);border:1px solid var(--success-color);}
.error{color:var(--danger-color);background-color:rgba(231,76,60,0.2);border:1px solid var(--danger-color);}

/* Search Bar */
.search-container{margin-top:0.5rem;display:flex;gap:0.5rem;flex-wrap:wrap;align-items:flex-end;}
.search-container input{
    flex:1;min-width:60%;margin-top:0;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    background: var(--input-bg-color);
    color: var(--text-color);
}
.search-container button {
    margin-top:0;width:auto;padding:0.54rem 0.9rem;font-size:0.765rem;
    box-shadow:0 2px 4px rgba(0,0,0,0.1);
}
.search-container button:hover {box-shadow:0 4px 8px rgba(0,0,0,0.2);}

/* Responsive */
@media(max-width:500px){
  body{padding:0.9rem;}
  .container{padding:1.35rem;}
  .row .half{min-width:100%;}
  .search-container{flex-direction:column;align-items:stretch;}
  .search-container input,.search-container button{width:100%;margin-top:0.72rem;}
  .button-group{flex-direction:column;}
  .compact-barcode-display{text-align:right;}
}
</style>
</head>
<body>
<!-- Ø¯Ú©Ù…Ù‡ Ø¯Ø§Ø±Ú©â€ŒÙ…Ø¯ -->
<button class="toggle-dark" id="toggleDark"><i class="fa-solid fa-moon"></i></button>

<div class="container">
<h2>ÙØ±Ù… Ø«Ø¨Øª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯ÛŒÙˆØ§ÛŒØ³â€ŒÙ‡Ø§ÛŒ Ù…Ø¹ÛŒÙˆØ¨</h2>

<form id="deviceForm">
<div class="compact-barcode-display">
  Ø¨Ø§Ø±Ú©Ø¯ ÙØ¹Ù„ÛŒ: <span id="barcodeDisplay">---</span>
</div>
<input type="hidden" id="barcodeId" name="barcodeId">

<!-- Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ -->
<div class="card">
  <div class="row">
    <div class="half">
      <label>Ù†Ø§Ù… Ø¯ÛŒÙˆØ§ÛŒØ³</label>
      <select name="deviceName" id="deviceName" required>
        <option value="">-- Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ --</option>
        <option value="Multi Media">Multi Media</option>
        <option value="Multi Media Metal">Multi Media Metal</option>
        <option value="Soul">Soul</option>
        <option value="Smart Player">Smart Player</option>
        <option value="TDA">TDA</option>
        <option value="RFID">RFID</option>
        <option value="Serial GSM">Serial GSM</option>
        <option value="Smart GSM">Smart GSM</option>
        <option value="MP3">MP3</option>
        <option value="IR">IR</option>
        <option value="B1">B1</option>
        <option value="Smart Plug">Smart Plug</option>
      </select>
    </div>
    <div class="half">
      <label>Ú©Ø¯ Ø¯ÛŒÙˆØ§ÛŒØ³</label>
      <input type="text" name="deviceCode" required>
    </div>
  </div>
</div>

<div class="card">
  <label>Ø§ÛŒØ±Ø§Ø¯</label>
  <input type="text" name="issue" required>
  <label>ØªØ§Ø±ÛŒØ® Ú¯Ø²Ø§Ø±Ø´ Ø§ÛŒØ±Ø§Ø¯</label>
  <input type="text" name="issueDate" id="issueDate" placeholder="ØªØ§Ø±ÛŒØ® Ú¯Ø²Ø§Ø±Ø´ Ø§ÛŒØ±Ø§Ø¯">
  <label>Ø´Ø±Ø­ Ø§ÛŒØ±Ø§Ø¯</label>
  <textarea name="issueDescription" rows="2"></textarea>
</div>

<div class="card">
  <label>Ø§Ù‚Ø¯Ø§Ù…Ø§Øª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡</label>
  <textarea name="actionsTaken" rows="2"></textarea>
  <label>ÙˆØ¶Ø¹ÛŒØª ÙØ¹Ù„ÛŒ</label>
  <input type="text" name="currentStatus">
  <label>ØªÙˆØ¶ÛŒØ­Ø§Øª ØªÚ©Ù…ÛŒÙ„ÛŒ</label>
  <textarea name="notes" rows="2"></textarea>
</div>

<div class="button-group">
  <button type="submit" id="saveBtn"><i class="fa-solid fa-floppy-disk"></i> Ø«Ø¨Øª/ÙˆÛŒØ±Ø§ÛŒØ´</button>
  <button type="button" id="deleteBtn"><i class="fa-solid fa-trash-can"></i> Ø­Ø°Ù</button>
</div>
</form>

<div class="message-container" id="messageContainer">
    <div class="message-box success" id="successMsg"></div>
    <div class="message-box error" id="errorMsg"></div>
</div>

<div class="search-container">
<input type="text" id="searchCode" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø± Ø§Ø³Ø§Ø³ Ú©Ø¯ Ø¯ÛŒÙˆØ§ÛŒØ³">
<button type="button" id="searchBtn"><i class="fa-solid fa-magnifying-glass"></i> Ø¬Ø³ØªØ¬Ùˆ</button>
</div>
</div>

<script>
const scriptURL = "https://script.google.com/macros/s/AKfycbwiFTGb_w8MRlEDdqqF6KqiTkRSm5yqqmLBs0OCWA665-engKt8dcwmqT4_QttYbnLgtw/exec";
const urlParams = new URLSearchParams(window.location.search);
const barcodeId = urlParams.get("barcodeId");
document.getElementById("barcodeId").value = barcodeId || "";
document.getElementById("barcodeDisplay").textContent = barcodeId || "---";

// ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ
$(document).ready(function() {
  $("#issueDate").persianDatepicker({format:"YYYY/MM/DD",autoClose:true,initialValue:false,calendar:{persian:{locale:"fa"}}});
});

// Ù¾ÛŒØ§Ù…
function showMessage(type, message) {
    const messageContainer=document.getElementById("messageContainer");
    const successMsg=document.getElementById("successMsg");
    const errorMsg=document.getElementById("errorMsg");
    const targetMsg=(type==="success")?successMsg:errorMsg;
    const otherMsg=(type==="success")?errorMsg:successMsg;
    targetMsg.textContent=message;
    messageContainer.classList.add("visible");
    targetMsg.style.display='block';otherMsg.style.display='none';
    setTimeout(()=>{messageContainer.classList.remove("visible");},4000);
}

function fillForm(data){
  if(!data) return;
  if(Object.keys(data).length>0){
    for(const key in data){
      const el=document.querySelector("[name='"+key+"']");
      if(el){if(el.type==="radio"||el.type==="checkbox"){el.checked=(el.value===data[key]);}else{el.value=data[key]||"";}}
    }
    document.getElementById("barcodeDisplay").textContent=data.barcodeId||"---";
    showMessage("success","âœ… Ø¯ÛŒÙˆØ§ÛŒØ³ Ø¨Ø§ Ø§ÛŒÙ† Ø¨Ø§Ø±Ú©Ø¯ Ù¾ÛŒØ¯Ø§ Ø´Ø¯");
  } else {showMessage("error","âŒ Ø¯ÛŒÙˆØ§ÛŒØ³ Ø¨Ø§ Ø§ÛŒÙ† Ø¨Ø§Ø±Ú©Ø¯ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯");}
}

function showLoading(buttonId, originalIconClass) {
  const button=document.getElementById(buttonId);
  button.dataset.originalIcon=originalIconClass;
  button.dataset.originalText=button.innerText.replace(/\s*$/,'');
  button.classList.add('loading');
  button.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i>';
}
function hideLoading(buttonId) {
  const button=document.getElementById(buttonId);
  button.classList.remove('loading');
  const originalIconClass=button.dataset.originalIcon;
  const originalText=button.dataset.originalText;
  if(originalIconClass&&originalText!==undefined){
    button.innerHTML=`<i class="${originalIconClass}"></i> ${originalText}`;
  }
}

if(barcodeId){
  fetch(`${scriptURL}?action=get&barcodeId=${encodeURIComponent(barcodeId)}`)
    .then(res=>res.json()).then(data=>{fillForm(data);})
    .catch(err=>{console.error("Ø®Ø·Ø§",err);showMessage("error","âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª");});
}

document.getElementById("deviceForm").addEventListener("submit",e=>{
  e.preventDefault();
  const formData=new FormData(e.target);
  showLoading('saveBtn','fa-solid fa-floppy-disk');
  fetch(scriptURL,{method:"POST",body:formData})
    .then(()=>{showMessage("success","âœ… Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯ÛŒÙˆØ§ÛŒØ³ Ø«Ø¨Øª Ø´Ø¯");})
    .catch(()=>{showMessage("error","âŒ Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª");})
    .finally(()=>{hideLoading('saveBtn');});
});

document.getElementById("deleteBtn").addEventListener("click",()=>{
  if(!barcodeId) return;
  if(!confirm("Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ")) return;
  showLoading('deleteBtn','fa-solid fa-trash-can');
  fetch(`${scriptURL}?action=delete&barcodeId=${encodeURIComponent(barcodeId)}`)
    .then(()=>{document.getElementById("deviceForm").reset();document.getElementById("barcodeDisplay").textContent="---";showMessage("success","âœ… Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯ÛŒÙˆØ§ÛŒØ³ Ø­Ø°Ù Ø´Ø¯");})
    .catch(()=>{showMessage("error","âŒ Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯ÛŒÙˆØ§ÛŒØ³");})
    .finally(()=>{hideLoading('deleteBtn');});
});

document.getElementById("searchBtn").addEventListener("click",()=>{
  const code=document.getElementById("searchCode").value.trim();
  if(!code) return showMessage("error","âŒ Ú©Ø¯ Ø¯ÛŒÙˆØ§ÛŒØ³ ÙˆØ§Ø±Ø¯ Ø´ÙˆØ¯");
  showLoading('searchBtn','fa-solid fa-magnifying-glass');
  fetch(`${scriptURL}?action=getByCode&deviceCode=${encodeURIComponent(code)}`)
    .then(res=>res.json()).then(data=>{
      if(Object.keys(data).length>0){
        fillForm(data);document.getElementById("barcodeId").value=data.barcodeId||"";showMessage("success","âœ… Ø¯ÛŒÙˆØ§ÛŒØ³ Ø¨Ø§ Ø§ÛŒÙ† Ú©Ø¯ Ù¾ÛŒØ¯Ø§ Ø´Ø¯");
      }else{showMessage("error","âŒ Ø¨Ø±Ø§ÛŒ Ú©Ø¯ ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡ Ø¯ÛŒÙˆØ§ÛŒØ³ÛŒ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯");}
    }).catch(()=>{showMessage("error","âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¬Ø³ØªØ¬Ùˆ");})
    .finally(()=>{hideLoading('searchBtn');});
});

// ğŸŒ™ ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø§Ø±Ú©â€ŒÙ…Ø¯
const toggleBtn=document.getElementById("toggleDark");
toggleBtn.addEventListener("click",()=>{
  document.body.classList.toggle("dark-mode");
  const icon=toggleBtn.querySelector("i");
  if(document.body.classList.contains("dark-mode")){
    icon.classList.replace("fa-moon","fa-sun");
  } else {
    icon.classList.replace("fa-sun","fa-moon");
  }
});
</script>
</body>
</html>
